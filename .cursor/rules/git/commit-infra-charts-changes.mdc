---
description: Action rule to commit InfraCharts changes with appropriate conventional commit messages
alwaysApply: false
---

# Rule: Commit InfraCharts Changes

## Purpose

When triggered, create a Git commit with an appropriate commit message following Conventional Commits format, based on the current conversation context and file changes.

## Rule Type

**Action Rule** - Executes git commit operations

## When to Use

- When user explicitly asks to commit changes
- After completing a chart update or new chart creation
- When wrapping up a development session

## Commit Message Format

Follow Conventional Commits format:

```
<type>(<scope>): <subject>

[optional body]

[optional footer]
```

### Types

Use these commit types:
- `feat`: New chart or significant new capability
- `fix`: Bug fix in chart templates
- `refactor`: Template restructuring (no functional changes)
- `docs`: README or documentation only changes
- `test`: Adding or updating tests
- `chore`: Build process, tooling, dependencies
- `style`: Template formatting (no logic changes)
- `ci`: CI/CD changes

### Scope

Determine scope from the affected chart(s):

#### Cloud Provider Charts
- `aws/<chart-name>`: AWS charts (e.g., `aws/ecs-environment`)
- `gcp/<chart-name>`: GCP charts (e.g., `gcp/cloud-run-environment`)
- `azure/<chart-name>`: Azure charts (e.g., `azure/aks-environment`)
- `kubernetes/<chart-name>`: Kubernetes charts

#### Chart Components
- `<provider>/<chart-name>/templates`: Template changes
- `<provider>/<chart-name>/values`: Values schema changes
- `<provider>/<chart-name>/docs`: Chart-specific documentation

#### Repository-wide
- `charts`: Multi-chart changes
- `docs`: Repository documentation
- `ci`: CI/CD configuration
- `repo`: Repository configuration changes

### Subject

- Use imperative mood ("add" not "added" or "adds")
- No period at the end
- Keep under 72 characters
- Be specific but concise

### Body (Optional)

Add detailed body when:
- The change is complex and needs explanation
- Multiple related changes are included
- Resources were added/removed from chart
- Template patterns changed significantly
- Context would help future developers understand "why"

Body guidelines:
- Wrap at 72 characters
- Explain what and why, not how
- Use bullet points for multiple items
- Reference issues/tickets if applicable

### Footer (Optional)

Include footer for:
- `BREAKING CHANGE:` for breaking changes to chart interface
- `Closes #123` or `Fixes #123` for issue references
- Co-authored-by for pair programming

## Execution Steps

1. **Analyze Changes**
   - Check `git status` to see modified files
   - Review the conversation context to understand what was changed
   - Identify which chart(s) were affected
   - Determine the type and scope of changes

2. **Determine Commit Type and Scope**
   - Map file changes to appropriate type
   - Determine most relevant scope from chart paths
   - For multi-chart changes, use broader scope

3. **Craft Commit Message**
   - Write concise subject line (< 72 chars)
   - Decide if detailed body is needed based on:
     - Complexity of changes
     - Number of resources affected
     - Need for future context
   - Add footer if there are breaking changes or issue references

4. **Create Commit**
   - Stage all changes with `git add -A`
   - Commit with the crafted message using `git commit -m "subject" [-m "body"]`
   - Use `-m` flag multiple times for subject + body, or use multiline format

## Examples

### New Chart Creation

```bash
git commit -m "feat(gcp/cloud-run-environment): add complete environment chart with conditional resources"
```

### Chart Enhancement

```bash
git commit -m "feat(gcp/cloud-run-environment): add synthetic relationships for deployment ordering" \
  -m "- Add conditional relationships between services and infrastructure
- Services now wait for database, storage, and registry
- Backend service depends on storage bucket and service account
- All relationships conditional based on enabled flags"
```

### Template Bug Fix

```bash
git commit -m "fix(aws/ecs-environment): correct security group port reference"
```

### Values Schema Update

```bash
git commit -m "feat(gcp/cloud-run-environment): add boolean flags for optional resources" \
  -m "- Add postgresEnabled, dockerRepoEnabled, storageBucketEnabled flags
- Add serviceAccountEnabled and dnsZoneEnabled flags
- All flags default to true for complete environment
- Enable users to disable unnecessary resources per environment"
```

### Documentation Update

```bash
git commit -m "docs(gcp/cloud-run-environment): document resource relationships and deployment order"
```

### Multi-Chart Refactoring

```bash
git commit -m "refactor(charts): standardize conditional resource pattern" \
  -m "- Extract common Jinja2 patterns for boolean flags
- Standardize relationship structure across charts
- Update AWS, GCP, and Azure charts
- No functional changes to deployments"
```

### Breaking Change

```bash
git commit -m "feat(aws/ecs-environment)!: restructure network template" \
  -m "BREAKING CHANGE: VPC configuration moved from root to network section.

Update values.yaml:
  Before: vpc_cidr
  After: network.vpc_cidr

This change improves values organization and aligns with other charts."
```

### Changelog Addition

```bash
git commit -m "docs(changelog): add GCP Cloud Run environment overhaul changelog"
```

## Command Patterns

For simple commits:
```bash
git add -A && git commit -m "<type>(<scope>): <subject>"
```

For commits with body:
```bash
git add -A && git commit -m "<type>(<scope>): <subject>" -m "<body>"
```

For commits with multi-paragraph body:
```bash
git add -A
git commit -m "<type>(<scope>): <subject>" \
  -m "<paragraph 1>" \
  -m "" \
  -m "<paragraph 2>"
```

## Important Notes

- **Always run in infra-charts workspace**: `/Users/swarup/scm/github.com/plantonhq/infra-charts`
- **Don't commit without reviewing**: Show the proposed commit message to the user before executing if the changes are significant
- **Stage selectively if needed**: If only some changes should be committed, stage specific files instead of `git add -A`
- **Don't skip hooks**: Never use `--no-verify` unless explicitly requested
- **Check for unstaged changes**: Review `git status` output to ensure all intended changes are staged
- **Chart-specific scope**: Always include the chart path in scope for clarity

## Error Handling

If commit fails:
- Check if there are actually changes to commit
- Verify you're in the correct directory
- Check if a commit is already in progress (merge/rebase)
- Ensure commit message format is valid

## Workflow Integration

This rule works well with:
- `@create-infra-charts-changelog.mdc` - Create changelog before committing major chart changes
- After completing chart development or updates
- Before creating a pull request

## Execution

When this rule is triggered:

1. Navigate to infra-charts workspace
2. Run `git status` to check current changes
3. Analyze changes and conversation context
4. Propose commit message following the format above
5. Execute the commit command with appropriate permissions (git_write)
6. Confirm successful commit
